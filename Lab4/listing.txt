1. ./Lab4.cs
Ôªøusing Core;
using Markdig;
using System.Text;
using System.Web;
using MathNet.Numerics.Distributions;
using Microsoft.Win32.SafeHandles;

namespace Lab4
{
    internal class Lab4
    {
        private const string SOURCE_FILENAME = "sourceData.txt";
        private const string REPORT_FILENAME = "report4.html";

        public static readonly double[] _sourceData = Utils.ReadValues(SOURCE_FILENAME)
            .GetAwaiter()
            .GetResult();

        private const string TMP_DIRECTORY_NAME = "tmp";

        private const double A = 0.025;

        static async Task Main(string[] args)
        {
            PrepareEnvironment();

            var metrics = Metrics.CountMetrics(
                _sourceData,
                [(int)Math.Round(0.55 * Math.Pow(_sourceData.Length, 0.4) + 1),
                 (int)Math.Round(1.25 * Math.Pow(_sourceData.Length, 0.4) - 1)]);

            await CreateReport(metrics);
        }

        private static async Task CreateReport(DataSetMetrics metrics)
        {
            await File.WriteAllLinesAsync(
                REPORT_FILENAME,
                [@"
                <style>
                table, th, td {
                       border: 1px solid black;
                }
                </style>"]);

            var html = new StringBuilder();

            html.AppendLine(Markdown.ToHtml("# –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Ññ4"));

            html.AppendLine(Markdown.ToHtml("# 1. –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞"));

            foreach (var (order, stat) in metrics.QSegmentStatistics)
            {
                var fileName = BuildBars(stat);

                html.AppendLine(Markdown.ToHtml($"## q = {order}"));
                html.AppendLine(Utils.BuildSegmentStatTableHtml(stat));

                html.AppendLine(
                    HttpUtility.UrlDecode(
                        Markdown.ToHtml(
                            $"![–ì—Ä–∞—Ñ–∏–∫]({fileName} \"–ì—Ä–∞—Ñ–∏–∫ q = {order}\")")));
            }                        

            var staticticsHtml = BuildStatisticsHtml(metrics);

            html.AppendLine(Markdown.ToHtml("# 2. –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏"));

            html.AppendLine(staticticsHtml);

            html.AppendLine(Markdown.ToHtml("# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–∏–ø–æ—Ç–µ–∑—ã –æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è"));
            
            html.AppendLine(BuildNormHtmlTable(metrics));

            html.Append(Markdown.ToHtml("–ü–æ —Ç–∞–±–ª–∏—Ü–µ –∫–≤–∞–Ω—Ç–∏–ª–µ–π ùúí2 —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, " +
                "–ø—Ä–∏ –∑–∞–¥–∞–Ω–Ω–æ–º —É—Ä–æ–≤–Ω–µ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏ Œ±=0,025 " +
                "–∏ —á–∏—Å–ª–µ —Å—Ç–µ–ø–µ–Ω–µ–π —Å–≤–æ–±–æ–¥—ã ùúà=ùëò‚àíùëü‚àí1=7‚àí2‚àí1=4, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ = 11.143. " +
                "–û—Å–Ω–æ–≤–∞–Ω–∏–π –¥–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –≥–∏–ø–æ—Ç–µ–∑—ã –Ω–µ—Ç."));

            await File.AppendAllLinesAsync(
                REPORT_FILENAME, 
                [html.ToString()]);

            Utils.OpenPath(REPORT_FILENAME);
        }

        private static string BuildStatisticsHtml(DataSetMetrics metrics)
        {
            var markdown = new StringBuilder();

            markdown.AppendLine($"+ –ú–∞—Ç. –æ–∂–∏–¥–∞–Ω–∏–µ {metrics.ExpectValue}");
            markdown.AppendLine($"+ –ú–µ–¥–∏–∞–Ω–∞ {metrics.Median}");
            markdown.AppendLine($"+ –ú–æ–¥–∞ {metrics.Mode}");
            markdown.AppendLine($"+ –î–∏—Å–ø–µ—Ä—Å–∏—è {metrics.D}");
            markdown.AppendLine($"+ –°—Ä. –∫–≤. –æ—Ç–∫–ª. {metrics.Sigma}");
            markdown.AppendLine($"+ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∞—Å—Å–∏–º–µ—Ç—Ä–∏–∏ {metrics.Skewness}");
            markdown.AppendLine($"+ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —ç–∫—Å—Ü–µ—Å—Å–∞ {metrics.ExcessKurtosis}");
            markdown.AppendLine($"+ –°—Ç. –æ—à–∏–±–∫–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ {metrics.StandardError}");
            markdown.AppendLine($"+ –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ, a = " +
                $"{A}: {metrics.ExpectValue} ¬± {metrics.GetTValue(A) * metrics.StandardError}");

            return Markdown.ToHtml(markdown.ToString());
        }

        private static MarkdownPipeline pipeline = new MarkdownPipelineBuilder()
            .UseAdvancedExtensions()
            .Build();

        private static string BuildNormHtmlTable(DataSetMetrics metrics)
        {
            var markdown = new StringBuilder();

            var segments = metrics.QSegmentStatistics.MaxBy(kv => kv.Key).Value;

            //SegmentStatisticsPart? prevPart = null;

            markdown.AppendLine("|‚Ññ|x j|x j+1|nj|–§(x)| –§(x+1)|pj|N * pj|(n_j-N‚àôp_j )^2|(n_j-N‚àôp_j )^2/(N‚àôp_j )|");
            markdown.AppendLine("|---|---|---|---|---|---|---|---|---|---|");

            Func<double, double> norm = value => Norm(value, metrics.ExpectValue, metrics.Sigma);

            int cnt = 0;

            double countedSum = 0;

            foreach (var (_, part) in segments.Parts)
            {
                cnt++;

                var fFrom = cnt == 1 ? 0 : norm(part.From);
                var fTo = cnt == segments.Parts.Count ? 1 : norm(part.To);
                var diff = fTo - fFrom;

                var counted1 = Math.Pow(part.Values.Length - segments.ValuesCount * diff, 2);
                var counted2 = counted1 / (segments.ValuesCount * diff);

                markdown.Append($"|{cnt.ToString("0.0000")}|{part.From}|{part.To}|{part.Values.Length}");
                markdown.Append($"|{fFrom}|{fTo}|{diff}|{diff * segments.ValuesCount}");
                markdown.AppendLine($"|{counted1}|{counted2}|");

                countedSum += counted2;
            }

            markdown.Append($"|–°—É–º–º–∞|-|-|{segments.ValuesCount}");
            markdown.Append($"|-|-|1|{ segments.ValuesCount}");
            markdown.AppendLine($"|œá02=|{countedSum}|");

            return Markdown.ToHtml(markdown.ToString(), pipeline);
        }

        /// <summary>
        /// –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
        /// </summary>
        /// <param name="X">–ó–Ω–∞—á–µ–Ω–∏–µ</param>
        /// <param name="M">–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ</param>
        /// <param name="S">–°—Ä–µ–¥–Ω–µ–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ</param>
        /// <returns></returns>
        private static double Norm(double X, double M = 0, double S = 1)
        {
            return Normal.CDF(M, S, X);
        }

        private static string BuildBars(SegmentStatistics statistics)
        {
            var plot = PlotBuilder.BuildGistogram(statistics);

            var fileName = Path.GetRandomFileName() + ".png";

            fileName = Path.Combine(TMP_DIRECTORY_NAME, fileName);

            plot.SavePng(fileName, 800, 600);
            return fileName;
        }

        private static void PrepareEnvironment()
        {
            if (Directory.Exists(TMP_DIRECTORY_NAME))
            {
                Directory.Delete(TMP_DIRECTORY_NAME, true);
            }

            if (!Directory.Exists(TMP_DIRECTORY_NAME))
            {
                Directory.CreateDirectory(TMP_DIRECTORY_NAME);
            }
        }
    }
}

